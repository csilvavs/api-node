name: ðŸš€ Deploy SAPUI5 app to EC2 with Docker + Docker Compose

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: â¬‡ï¸ Clonar repositorio
      uses: actions/checkout@v3

    - name: ðŸŸ¢ Instalar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ðŸ“¦ Instalar dependencias del proyecto
      run: npm install

    - name: ðŸ§ª Run Unit Tests
      run: |
        nohup fiori run --config ./ui5-mock.yaml > /dev/null 2>&1 &
      
        # Espera a que el servidor estÃ© listo
        sleep 15
      
        # Ejecuta las pruebas (usa curl o wget para verificar)
        curl -s http://localhost:8080/test/unit/unitTests.qunit.html | grep "tests completed"
      
        # Mata el proceso del servidor
        pkill -f "fiori run"
    - name: ðŸ”§ Instalar UI5 CLI
      run: npm install --save-dev @ui5/cli

    - name: ðŸ› ï¸ Ejecutar build SAPUI5
      run: npx ui5 build --all --clean-dest --dest dist

    - name: ðŸ“¦ Empaquetar proyecto para Docker
      run: tar -czf sapui5-deploy.tar.gz Dockerfile docker-compose.yml nginx.conf dist/

    - name: ðŸ”‘ Crear archivo de llave SSH
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
        chmod 600 key.pem

    - name: ðŸš€ Subir y desplegar en EC2 con Docker Compose
      run: |
        scp -o StrictHostKeyChecking=no -i key.pem sapui5-deploy.tar.gz ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/
        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          echo "ðŸ“¦ Descomprimiendo archivos..."
          tar -xzf sapui5-deploy.tar.gz -C /home/ubuntu/

          echo "ðŸ³ Creando y ejecutando contenedor con Docker Compose..."
          cd /home/ubuntu
          docker-compose down || true
          docker-compose up --build -d

          echo "âœ… Despliegue completado. Tu app estÃ¡ disponible en el puerto 80."
        EOF
