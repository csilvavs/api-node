name: ğŸš€ Deploy SAPUI5 app to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: â¬‡ï¸ Clonar repositorio
      uses: actions/checkout@v3

    - name: ğŸŸ¢ Instalar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ğŸ“¦ Instalar dependencias del proyecto
      run: npm install

    - name: ğŸ”§ Instalar UI5 CLI
      run: npm install --save-dev @ui5/cli

    - name: ğŸ› ï¸ Ejecutar build UI5
      run: npx ui5 build --all --clean-dest --dest dist

    - name: ğŸ“‚ Comprimir build (dist)
      run: zip -r dist.zip dist

    - name: ğŸ”‘ Crear llave SSH
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
        chmod 600 key.pem

    - name: ğŸš€ Subir build a EC2 y configurar Nginx
      run: |
        scp -i key.pem dist.zip ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/dist.zip
        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          # Instalar Nginx si no estÃ¡
          if ! command -v nginx &> /dev/null
          then
            echo "âš™ï¸ Instalando Nginx..."
            sudo apt update
            sudo apt install -y nginx
            sudo systemctl enable nginx
          fi

          echo "ğŸ§¹ Limpiando contenido anterior..."
          sudo rm -rf /var/www/html/*

          echo "ğŸ“¦ Descomprimiendo build..."
          unzip -o /home/ubuntu/dist.zip -d /home/ubuntu/

          echo "ğŸ“ Copiando a /var/www/html..."
          sudo cp -r /home/ubuntu/dist/* /var/www/html/

          echo "ğŸ”„ Reiniciando Nginx..."
          sudo systemctl restart nginx
        EOF
