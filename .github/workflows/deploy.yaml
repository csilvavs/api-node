name: 🚀 Deploy SAPUI5 app to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ⬇️ Clonar repositorio
      uses: actions/checkout@v3

    - name: 🟢 Instalar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: 📦 Instalar dependencias del proyecto
      run: npm install

    - name: 🔧 Instalar UI5 CLI
      run: npm install --save-dev @ui5/cli

    - name: 🛠️ Ejecutar build UI5
      run: npx ui5 build --all --clean-dest --dest dist

    - name: 📂 Comprimir build (dist)
      run: zip -r dist.zip dist

    - name: 🔑 Crear llave SSH
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
        chmod 600 key.pem

    - name: 🚀 Subir build a EC2 y configurar Nginx
      run: |
        scp -i key.pem dist.zip ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/dist.zip
        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          # Instalar Nginx si no está
          if ! command -v nginx &> /dev/null
          then
            echo "⚙️ Instalando Nginx..."
            sudo apt update
            sudo apt install -y nginx
            sudo systemctl enable nginx
          fi

          echo "🧹 Limpiando contenido anterior..."
          sudo rm -rf /var/www/html/*

          echo "📦 Descomprimiendo build..."
          unzip -o /home/ubuntu/dist.zip -d /home/ubuntu/

          echo "📁 Copiando a /var/www/html..."
          sudo cp -r /home/ubuntu/dist/* /var/www/html/

          echo "🔄 Reiniciando Nginx..."
          sudo systemctl restart nginx
        EOF
